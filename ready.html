<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <title>充电桩充电准备</title>
    <link rel="stylesheet" href="css/zy-style.css">
</head>
<body>
    <section id="chargePage" style="display:none;">
        <label class="charging-tip ">正在充电...</label>
        <aside class="charge new-btn ">
            <img src="images/4.png" id="charge">
            <p id="chargeTip" class="dis-none">
                已充
                <br><span id="amountHas">999</span>
                <span>度</span>
            </p>
            <label>点击查看当前充电量</label>
        </aside>
        <div class="new-btn mg-t-4">
            <a href="javascript:void(0);" class="login-btn" id="stopCharge">结束充电</a>
        </div>
    </section>
    <aside class="ready" id="readyPage">
        <img src="images/3.png">
        <a href ="javascript:return false;"class="login-btn" >取 &nbsp;&nbsp; &nbsp;  消</a>
    </aside>
</body>
<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/layer/layer.js"></script>
<script src="js/ajax.js?2019"></script>
<script>
    (function(){
        var internal;
        var readyObj = {
            orderSeq:"",
            init: function () {
                readyObj.chargeClick();
                //1秒刷新一次
                internal = setInterval(function () {
                    console.log("20秒强制刷新");
                    readyObj.getFirstPage();
                }, 20000);
                readyObj.stopChargeClick();
            },
            stopChargeClick: function(){//结束充电
                $("#stopCharge").on("click",function(){
                    $.ajaxByPost("/wechat/charge/order/end", {
                        orderSeq: readyObj.orderSeq,
                        token: localStorage.token
                    }, function (data) {
                        if (data.code == 200) {//成功
                        } else {
                            layer.msg(data["message"]);
                        }
                    });
                });
            },
            chargeClick:function(){
                $(".charge").click(function () {
                    if ($("#charge").attr("src") === "images/4.png") {
                        $("#charge").attr("src", "images/5.png");
                        $("#chargeTip").removeClass('dis-none');
                    }else {
                        $("#charge").attr("src", "images/4.png");
                        $("#chargeTip").addClass('dis-none');
                    }
                });
            },
            getFirstPage: function () {
                $.ajaxByPost("/wechat/charge/order/list", {
                    page: 1,
                    token: localStorage.token
                }, function (data) {
                    if (data.code == 200) {//成功
                        var d = data["data"];
                        $("#chargePage").hide();
                        $("#readyPage").show();
                        if (d.length > 0) {
                            readyObj.orderSeq = d[0]["orderSeq"];
                            var amount = d[0]["amount"];
                            $("#amountHas").html(amount);
                            var orderStatus = d[0]["orderStatus"];
                            if (orderStatus == 3) {
                                $("#chargePage").show();
                                $("#readyPage").hide();
//                                localStorage.orderSeq = "";
                            }else if(orderStatus == 4){
                                clearInterval(internal);
                                window.location.href="pay.html";
                            }
                            localStorage.orderSeq = d[0]["orderSeq"];// 将订单编号存储起来，以便重新扫码时使用
                        }
                    } else {
                        layer.msg(data["message"]);
                    }
                }, true);
            }
        };
        $(readyObj.init);
    })();
</script>
</html>